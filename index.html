<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DevSandbox</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/eclipse.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
    }
    body.light-theme { background: #f5f5f5; color: #333; }

    header {
      height: 50px;
      background: #1f1f1f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
    }
    .light-theme header { background: #e0e0e0; color: #333; }

    .menu-toggle, .settings-icon {
      font-size: 20px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }
    .light-theme .menu-toggle, .light-theme .settings-icon { color: #333; }

    .sidebar, .settings-panel {
      position: absolute;
      top: 50px;
      left: 0;
      width: 250px;
      background: #1c1c1c;
      height: calc(100% - 50px);
      padding: 10px;
      display: none;
      flex-direction: column;
      z-index: 10;
    }
    .sidebar.active, .settings-panel.active { display: flex; }
    .light-theme .sidebar, .light-theme .settings-panel {
      background: #e0e0e0; color: #333;
    }
    .sidebar button, .settings-panel input, .settings-panel select {
      background: #2c2c2c;
      color: #fff;
      border: none;
      margin: 5px 0;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .light-theme .sidebar button, .light-theme .settings-panel input, .light-theme .settings-panel select {
      background: #f0f0f0; color: #333;
    }

    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 10px;
      overflow: hidden;
    }

    .device-frame {
      width: 375px;
      height: 667px;
      background: #1e1e1e;
      border-radius: 20px;
      border: 2px solid #333;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 10px;
      flex-shrink: 0;
    }
    .light-theme .device-frame {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .editor-wrapper, .preview-wrapper {
      flex: 1;
      border-radius: 16px;
    }
    .editor-wrapper {
      overflow: auto;
    }
    .preview-wrapper {
      display: none;
    }

    .CodeMirror {
      font-size: 14px;
      height: 100%;
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    .light-theme .CodeMirror {
      background-color: #f8f8f8;
      color: #333;
    }
    .CodeMirror-gutters {
      background: #2a2a2a;
      color: #ccc;
      border-right: 1px solid #444;
    }
    .light-theme .CodeMirror-gutters {
      background: #e8e8e8;
      color: #666;
      border-right: 1px solid #ddd;
    }

    select.language-select {
      margin: 0 10px;
      padding: 6px;
      background: #2c2c2c;
      color: white;
      border: none;
      border-radius: 6px;
    }
    .light-theme select.language-select {
      background: #f0f0f0;
      color: #333;
    }

    #errorOutput {
      color: #ff5252;
      font-size: 14px;
      padding: 5px 10px;
      white-space: pre-wrap;
      max-height: 80px;
      overflow: auto;
    }
  </style>
</head>
<body onclick="hideMenus(event)">
  <header>
    <button class="menu-toggle no-close" onclick="toggleSidebar()">☰</button>
    <h1 style="font-size: 18px;">DevSandbox</h1>
    <select id="languageSelect" class="language-select">
      <option value="htmlmixed">HTML</option>
      <option value="javascript">JavaScript</option>
      <option value="css">CSS</option>
    </select>
    <button class="settings-icon no-close" onclick="toggleSettings()">⚙</button>
  </header>

  <div class="sidebar" id="sidebar">
    <button onclick="switchView('editor')">Редактировать</button>
    <button onclick="switchView('preview')">Предпросмотр</button>
    <button onclick="clearCode()">Очистить</button>
    <button onclick="exportCode()">Экспорт</button>
    <input type="file" id="importInput" hidden onchange="importCode(event)">
    <button onclick="document.getElementById('importInput').click()">Импорт</button>
  </div>

  <div class="settings-panel" id="settings">
    <label>Размер шрифта:
      <input type="range" id="fontSizeRange" min="10" max="24" value="14" onchange="applySettings()">
    </label>
    <label>Тема:
      <select id="themeSelect" onchange="applySettings()">
        <option value="dracula">Тёмная</option>
        <option value="eclipse">Светлая</option>
      </select>
    </label>
  </div>

  <div class="main">
    <div class="device-frame">
      <div id="editorPane" class="editor-wrapper">
        <textarea id="code"></textarea>
      </div>
      <div id="previewPane" class="preview-wrapper">
        <iframe id="previewFrame" style="width:100%; height:100%; border:none; background:white;"></iframe>
      </div>
      <div id="errorOutput"></div>
    </div>
  </div>

<script>
let editor;
const languageSelect = document.getElementById("languageSelect");
const errorOutput = document.getElementById("errorOutput");

editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  mode: languageSelect.value,
  theme: "dracula",
  lineNumbers: true,
  autoCloseBrackets: true
});
editor.setSize(null, "100%");

function updateMode() {
  const mode = languageSelect.value;
  editor.setOption("mode", mode);
  checkSyntax();
}

function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("active");
  document.getElementById("settings").classList.remove("active");
}

function toggleSettings() {
  document.getElementById("settings").classList.toggle("active");
  document.getElementById("sidebar").classList.remove("active");
}

function hideMenus(e) {
  if (
    !e.target.closest(".sidebar") &&
    !e.target.closest(".settings-panel") &&
    !e.target.closest(".no-close")
  ) {
    document.getElementById("sidebar").classList.remove("active");
    document.getElementById("settings").classList.remove("active");
  }
}
document.getElementById("sidebar").addEventListener("click", e => e.stopPropagation());
document.getElementById("settings").addEventListener("click", e => e.stopPropagation());

function applySettings() {
  const fontSize = document.getElementById("fontSizeRange").value;
  const theme = document.getElementById("themeSelect").value;
  document.querySelector(".CodeMirror").style.fontSize = fontSize + "px";
  editor.setOption("theme", theme);
  document.body.classList.toggle("light-theme", theme === "eclipse");
}

function switchView(view) {
  document.getElementById("editorPane").style.display = view === 'editor' ? 'block' : 'none';
  document.getElementById("previewPane").style.display = view === 'preview' ? 'block' : 'none';
  if (view === 'preview') {
    const html = editor.getValue();
    const iframe = document.getElementById("previewFrame");
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();
  }
}

function clearCode() {
  editor.setValue("");
  errorOutput.textContent = "";
  const iframe = document.getElementById("previewFrame");
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open();
  doc.write("");
  doc.close();
}

function exportCode() {
  const blob = new Blob([editor.getValue()], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "project.html";
  a.click();
}

function importCode(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    editor.setValue(e.target.result);
    checkSyntax();
  };
  reader.readAsText(file);
}

function checkSyntax() {
  const code = editor.getValue();
  const mode = languageSelect.value;
  errorOutput.textContent = "";

  try {
    if (mode === 'htmlmixed') {
      const parser = new DOMParser();
      const doc = parser.parseFromString(code, 'text/html');
      const error = doc.querySelector("parsererror");
      if (error) {
        errorOutput.textContent = "HTML-ошибка:\n" + error.textContent;
      }
    } else if (mode === 'javascript') {
      new Function(code);
    } else if (mode === 'css') {
      const style = document.createElement("style");
      style.textContent = code;
      document.head.appendChild(style);
      if (style.sheet && style.sheet.cssRules.length === 0 && code.trim() !== "") {
        errorOutput.textContent = "CSS-ошибка: возможно, правила написаны некорректно.";
      }
      document.head.removeChild(style);
    }
  } catch (e) {
    errorOutput.textContent = `Ошибка ${mode.toUpperCase()}:\n` + e.message;
  }
}

editor.on("change", checkSyntax);
languageSelect.addEventListener("change", updateMode);
</script>
</body>
</html>