<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ CodeVision - –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #2d2d3f;
            --bg-tertiary: #3d3d5c;
            --text-primary: #cdd6f4;
            --text-secondary: #a6adc8;
            --accent: #89b4fa;
            --accent-hover: #b4befe;
            --success: #a6e3a1;
            --warning: #f9e2af;
            --error: #f38ba8;
            --border: #45475a;
        }

        .light-theme {
            --bg-primary: #eff1f5;
            --bg-secondary: #e6e9ef;
            --bg-tertiary: #dce0e8;
            --text-primary: #4c4f69;
            --text-secondary: #6c6f85;
            --accent: #1e66f5;
            --accent-hover: #7287fd;
            --success: #40a02b;
            --warning: #df8e1d;
            --error: #d20f39;
            --border: #bcc0cc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .logo-icon {
            font-size: 1.5em;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent);
            color: var(--bg-primary);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
        }

        /* Toolbar */
        .toolbar {
            background: var(--bg-secondary);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        select {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
        }

        select:focus {
            outline: 2px solid var(--accent);
        }

        /* Tabs */
        .tabs-container {
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            background: transparent;
            color: var(--text-secondary);
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1em;
            padding: 2px;
            border-radius: 4px;
        }

        .tab-close:hover {
            background: var(--error);
            color: white;
        }

        .add-tab {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .add-tab:hover {
            background: var(--accent);
        }

        /* Main Editor Area */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 50px;
        }

        .sidebar-header {
            padding: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2em;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
        }

        .file-item.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* Editor */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .line-numbers {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 15px 10px;
            text-align: right;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            user-select: none;
            overflow: hidden;
            min-width: 50px;
            border-right: 1px solid var(--border);
        }

        .code-area {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .code-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: transparent;
            caret-color: var(--text-primary);
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
            border: none;
            resize: none;
            outline: none;
            overflow: auto;
            white-space: pre;
            z-index: 2;
        }

        .code-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
            overflow: auto;
            white-space: pre;
            pointer-events: none;
            z-index: 1;
        }

        /* Syntax Colors */
        .keyword { color: #cba6f7; }
        .string { color: #a6e3a1; }
        .number { color: #fab387; }
        .comment { color: #6c7086; font-style: italic; }
        .function { color: #89b4fa; }
        .operator { color: #89dceb; }
        .tag { color: #f38ba8; }
        .attr { color: #f9e2af; }
        .punctuation { color: #cdd6f4; }
        .class-name { color: #f9e2af; }
        .property { color: #94e2d5; }
        .boolean { color: #fab387; }
        .regex { color: #f5c2e7; }

        .light-theme .keyword { color: #8839ef; }
        .light-theme .string { color: #40a02b; }
        .light-theme .number { color: #fe640b; }
        .light-theme .comment { color: #9ca0b0; }
        .light-theme .function { color: #1e66f5; }
        .light-theme .tag { color: #d20f39; }
        .light-theme .attr { color: #df8e1d; }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-left, .status-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5em;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1em;
        }

        .form-group input:focus {
            outline: 2px solid var(--accent);
        }

        /* Preview Panel */
        .preview-panel {
            width: 50%;
            border-left: 1px solid var(--border);
            display: none;
            flex-direction: column;
        }

        .preview-panel.active {
            display: flex;
        }

        .preview-header {
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            background: white;
            overflow: auto;
        }

        .preview-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Search Panel */
        .search-panel {
            background: var(--bg-secondary);
            padding: 10px 15px;
            display: none;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .search-panel.active {
            display: flex;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .search-results {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Minimap */
        .minimap {
            width: 80px;
            background: var(--bg-tertiary);
            overflow: hidden;
            position: relative;
            border-left: 1px solid var(--border);
        }

        .minimap-content {
            transform: scale(0.15);
            transform-origin: top left;
            width: 666%;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 15px;
            color: var(--text-secondary);
            white-space: pre;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: var(--bg-primary);
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.active {
            display: flex;
        }

        .toast.error {
            background: var(--error);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Stats Panel */
        .stats-panel {
            padding: 10px;
            border-top: 1px solid var(--border);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                height: 100%;
                z-index: 100;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .preview-panel {
                position: fixed;
                right: 0;
                top: 0;
                width: 100%;
                height: 100%;
                z-index: 100;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .toolbar {
                justify-content: center;
            }

            .minimap {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">üöÄ</span>
            <span>CodeVision</span>
        </div>
        <div class="header-actions">
            <button class="btn" onclick="toggleSidebar()" title="–§–∞–π–ª—ã">üìÅ</button>
            <button class="btn" onclick="newFile()">‚ûï –ù–æ–≤—ã–π</button>
            <button class="btn" onclick="openFileDialog()">üìÇ –û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn btn-success" onclick="saveFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" onclick="exportProject()">üì¶ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn" onclick="togglePreview()">üëÅÔ∏è –ü—Ä–µ–≤—å—é</button>
            <button class="btn" onclick="toggleTheme()">üåô</button>
            <button class="btn" onclick="showSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <label>–Ø–∑—ã–∫:</label>
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="javascript">JavaScript</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="python">Python</option>
                <option value="json">JSON</option>
                <option value="typescript">TypeScript</option>
                <option value="java">Java</option>
                <option value="csharp">C#</option>
                <option value="cpp">C++</option>
                <option value="php">PHP</option>
                <option value="ruby">Ruby</option>
                <option value="go">Go</option>
                <option value="rust">Rust</option>
                <option value="sql">SQL</option>
                <option value="markdown">Markdown</option>
                <option value="xml">XML</option>
                <option value="yaml">YAML</option>
                <option value="swift">Swift</option>
                <option value="kotlin">Kotlin</option>
            </select>
        </div>
        <div class="toolbar-group">
            <label>–†–∞–∑–º–µ—Ä:</label>
            <select id="fontSizeSelect" onchange="changeFontSize()">
                <option value="12">12px</option>
                <option value="14" selected>14px</option>
                <option value="16">16px</option>
                <option value="18">18px</option>
                <option value="20">20px</option>
            </select>
        </div>
        <button class="btn" onclick="toggleSearch()">üîç –ü–æ–∏—Å–∫</button>
        <button class="btn" onclick="formatCode()">‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" onclick="clearCode()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
        <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." oninput="performSearch()">
        <input type="text" class="search-input" id="replaceInput" placeholder="–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞...">
        <button class="btn" onclick="replaceAll()">–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—ë</button>
        <span class="search-results" id="searchResults">0 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</span>
        <button class="btn" onclick="toggleSearch()">‚úñ</button>
    </div>

    <!-- Tabs -->
    <div class="tabs-container" id="tabsContainer">
        <button class="add-tab" onclick="newFile()">+</button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span>üìÅ –§–∞–π–ª—ã</span>
                <button class="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
            </div>
            <div class="file-tree" id="fileTree"></div>
            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statLines">0</div>
                        <div class="stat-label">–°—Ç—Ä–æ–∫–∏</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statChars">0</div>
                        <div class="stat-label">–°–∏–º–≤–æ–ª—ã</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statWords">0</div>
                        <div class="stat-label">–°–ª–æ–≤–∞</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSize">0B</div>
                        <div class="stat-label">–†–∞–∑–º–µ—Ä</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Editor Container -->
        <div class="editor-container">
            <div class="editor-wrapper">
                <div class="line-numbers" id="lineNumbers">1</div>
                <div class="code-area">
                    <div class="code-display" id="codeDisplay"></div>
                    <textarea class="code-input" id="codeInput" spellcheck="false" placeholder="// –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∫–æ–¥ –∑–¥–µ—Å—å..."></textarea>
                </div>
                <div class="minimap" id="minimap">
                    <div class="minimap-content" id="minimapContent"></div>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel" id="previewPanel">
            <div class="preview-header">
                <span>üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                <button class="btn" onclick="togglePreview()">‚úñ</button>
            </div>
            <div class="preview-content">
                <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <span class="status-item">üìç <span id="cursorPos">–°—Ç—Ä–æ–∫–∞ 1, –ö–æ–ª–æ–Ω–∫–∞ 1</span></span>
            <span class="status-item">üìù <span id="currentLang">JavaScript</span></span>
            <span class="status-item">üìÅ <span id="currentFile">untitled.js</span></span>
        </div>
        <div class="status-right">
            <span class="status-item">üí° Ctrl+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å | Ctrl+F - –ø–æ–∏—Å–∫</span>
            <span class="status-item" id="autoSaveStatus">‚úÖ –ì–æ—Ç–æ–≤–æ</span>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" style="display:none" accept="*" onchange="handleFileOpen(event)" multiple>

    <script>
        // State
        let files = [];
        let activeFileId = null;
        let isDarkTheme = true;

        // Language patterns for syntax highlighting
        const syntaxPatterns = {
            javascript: [
                { pattern: /(\/\/.*$)/gm, class: 'comment' },
                { pattern: /(\/\*[\s\S]*?\*\/)/g, class: 'comment' },
                { pattern: /\b(const|let|var|function|return|if|else|for|while|do|switch|case|break|continue|new|class|extends|import|export|from|default|async|await|try|catch|finally|throw|typeof|instanceof|in|of|this|super|static|get|set|yield)\b/g, class: 'keyword' },
                { pattern: /\b(true|false|null|undefined|NaN|Infinity)\b/g, class: 'boolean' },
                { pattern: /("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'|`(?:[^`\\]|\\.)*`)/g, class: 'string' },
                { pattern: /\b(\d+\.?\d*)\b/g, class: 'number' },
                { pattern: /\b([A-Z][a-zA-Z0-9]*)\b/g, class: 'class-name' },
                { pattern: /\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g, class: 'function' },
                { pattern: /(=>|\.\.\.|\?\.|\?\?|&&|\|\||[+\-*/%=<>!&|^~]+)/g, class: 'operator' },
            ],
            html: [
                { pattern: /(&lt;!--[\s\S]*?--&gt;)/g, class: 'comment' },
                { pattern: /(&lt;\/?)([\w-]+)/g, replace: '<span class="punctuation">$1</span><span class="tag">$2</span>' },
                { pattern: /\s([\w-]+)(=)/g, replace: ' <span class="attr">$1</span><span class="punctuation">$2</span>' },
                { pattern: /("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
            ],
            css: [
                { pattern: /(\/\*[\s\S]*?\*\/)/g, class: 'comment' },
                { pattern: /([.#]?[\w-]+)\s*\{/g, replace: '<span class="tag">$1</span> {' },
                { pattern: /([\w-]+)\s*:/g, replace: '<span class="property">$1</span>:' },
                { pattern: /:\s*([^;{}]+)/g, replace: ': <span class="string">$1</span>' },
                { pattern: /\b(\d+\.?\d*(px|em|rem|%|vh|vw|s|ms)?)\b/g, class: 'number' },
            ],
            python: [
                { pattern: /(#.*$)/gm, class: 'comment' },
                { pattern: /("""[\s\S]*?"""|'''[\s\S]*?''')/g, class: 'string' },
                { pattern: /\b(def|class|if|elif|else|for|while|try|except|finally|with|as|import|from|return|yield|lambda|pass|break|continue|raise|global|nonlocal|assert|del|in|is|and|or|not|True|False|None)\b/g, class: 'keyword' },
                { pattern: /("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
                { pattern: /\b(\d+\.?\d*)\b/g, class: 'number' },
                { pattern: /\b([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/g, class: 'function' },
                { pattern: /@(\w+)/g, class: 'function' },
            ],
            json: [
                { pattern: /("(?:[^"\\]|\\.)*")\s*:/g, replace: '<span class="property">$1</span>:' },
                { pattern: /:\s*("(?:[^"\\]|\\.)*")/g, replace: ': <span class="string">$1</span>' },
                { pattern: /\b(true|false|null)\b/g, class: 'boolean' },
                { pattern: /\b(-?\d+\.?\d*)\b/g, class: 'number' },
            ],
            sql: [
                { pattern: /(--.*$)/gm, class: 'comment' },
                { pattern: /\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|IN|LIKE|INSERT|INTO|VALUES|UPDATE|SET|DELETE|CREATE|TABLE|INDEX|DROP|ALTER|ADD|PRIMARY|KEY|FOREIGN|REFERENCES|ORDER|BY|GROUP|HAVING|LIMIT|OFFSET|AS|DISTINCT|UNION|ALL|NULL|IS|BETWEEN|EXISTS|CASE|WHEN|THEN|ELSE|END)\b/gi, class: 'keyword' },
                { pattern: /('(?:[^'\\]|\\.)*')/g, class: 'string' },
                { pattern: /\b(\d+\.?\d*)\b/g, class: 'number' },
            ],
            markdown: [
                { pattern: /^(#{1,6}\s.*)$/gm, class: 'keyword' },
                { pattern: /(\*\*.*?\*\*|__.*?__)/g, class: 'tag' },
                { pattern: /(\*.*?\*|_.*?_)/g, class: 'string' },
                { pattern: /(`[^`]+`)/g, class: 'function' },
                { pattern: /(\[.*?\]\(.*?\))/g, class: 'attr' },
                { pattern: /^(\s*[-*+]\s)/gm, class: 'operator' },
                { pattern: /^(\s*\d+\.\s)/gm, class: 'number' },
            ],
            typescript: [], // Will use JavaScript patterns
            java: [],
            csharp: [],
            cpp: [],
            php: [],
            ruby: [],
            go: [],
            rust: [],
            xml: [],
            yaml: [],
            swift: [],
            kotlin: []
        };

        // Copy JS patterns to similar languages
        ['typescript', 'java', 'csharp', 'cpp', 'go', 'rust', 'swift', 'kotlin'].forEach(lang => {
            syntaxPatterns[lang] = syntaxPatterns.javascript;
        });
        syntaxPatterns.xml = syntaxPatterns.html;
        syntaxPatterns.php = [
            ...syntaxPatterns.javascript,
            { pattern: /(<\?php|\?>)/g, class: 'tag' },
            { pattern: /(\$\w+)/g, class: 'property' },
        ];
        syntaxPatterns.ruby = [
            { pattern: /(#.*$)/gm, class: 'comment' },
            { pattern: /\b(def|end|class|module|if|elsif|else|unless|case|when|while|until|for|do|begin|rescue|ensure|raise|return|yield|next|break|retry|self|nil|true|false|and|or|not|in|then|require|include|extend|attr_accessor|attr_reader|attr_writer)\b/g, class: 'keyword' },
            { pattern: /("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g, class: 'string' },
            { pattern: /(:\w+)/g, class: 'attr' },
            { pattern: /(@\w+)/g, class: 'property' },
            { pattern: /\b(\d+\.?\d*)\b/g, class: 'number' },
        ];
        syntaxPatterns.yaml = [
            { pattern: /(#.*$)/gm, class: 'comment' },
            { pattern: /^(\s*[\w-]+):/gm, replace: '<span class="property">$1</span>:' },
            { pattern: /:\s*(.+)$/gm, replace: ': <span class="string">$1</span>' },
            { pattern: /\b(true|false|null|yes|no)\b/gi, class: 'boolean' },
            { pattern: /\b(\d+\.?\d*)\b/g, class: 'number' },
        ];

        // Language extensions map
        const langExtensions = {
            javascript: 'js', html: 'html', css: 'css', python: 'py',
            json: 'json', typescript: 'ts', java: 'java', csharp: 'cs',
            cpp: 'cpp', php: 'php', ruby: 'rb', go: 'go', rust: 'rs',
            sql: 'sql', markdown: 'md', xml: 'xml', yaml: 'yml',
            swift: 'swift', kotlin: 'kt'
        };

        const extToLang = Object.fromEntries(
            Object.entries(langExtensions).map(([k, v]) => [v, k])
        );
        extToLang['js'] = 'javascript';

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            newFile();
            setupEventListeners();
        });

        function setupEventListeners() {
            const codeInput = document.getElementById('codeInput');
            
            codeInput.addEventListener('input', () => {
                updateHighlighting();
                updateLineNumbers();
                updateStats();
                updateMinimap();
                syncScroll();
            });

            codeInput.addEventListener('scroll', syncScroll);

            codeInput.addEventListener('keydown', (e) => {
                handleKeydown(e);
            });

            codeInput.addEventListener('click', updateCursorPosition);
            codeInput.addEventListener('keyup', updateCursorPosition);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 's') {
                        e.preventDefault();
                        saveFile();
                    } else if (e.key === 'f') {
                        e.preventDefault();
                        toggleSearch();
                    } else if (e.key === 'n') {
                        e.preventDefault();
                        newFile();
                    }
                }
            });
        }

        function handleKeydown(e) {
            const textarea = e.target;
            
            // Tab support
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                
                if (e.shiftKey) {
                    // Unindent
                    const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                    if (value.substring(lineStart, lineStart + 2) === '  ') {
                        textarea.value = value.substring(0, lineStart) + value.substring(lineStart + 2);
                        textarea.selectionStart = textarea.selectionEnd = start - 2;
                    }
                } else {
                    // Indent
                    textarea.value = value.substring(0, start) + '  ' + value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + 2;
                }
                updateHighlighting();
            }

            // Auto-close brackets
            const pairs = { '(': ')', '[': ']', '{': '}', '"': '"', "'": "'", '`': '`' };
            if (pairs[e.key]) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;
                
                if (start === end) {
                    e.preventDefault();
                    textarea.value = value.substring(0, start) + e.key + pairs[e.key] + value.substring(end);
                    textarea.selectionStart = textarea.selectionEnd = start + 1;
                    updateHighlighting();
                }
            }

            // Auto-indent on Enter
            if (e.key === 'Enter') {
                const start = textarea.selectionStart;
                const value = textarea.value;
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const line = value.substring(lineStart, start);
                const indent = line.match(/^\s*/)[0];
                const lastChar = value[start - 1];
                
                if ('{(['.includes(lastChar)) {
                    e.preventDefault();
                    const extra = indent + '  ';
                    textarea.value = value.substring(0, start) + '\n' + extra + '\n' + indent + value.substring(start);
                    textarea.selectionStart = textarea.selectionEnd = start + 1 + extra.length;
                    updateHighlighting();
                } else if (indent) {
                    e.preventDefault();
                    textarea.value = value.substring(0, start) + '\n' + indent + value.substring(start);
                    textarea.selectionStart = textarea.selectionEnd = start + 1 + indent.length;
                    updateHighlighting();
                }
            }
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function highlightSyntax(code, language) {
            let html = escapeHtml(code);
            const patterns = syntaxPatterns[language] || syntaxPatterns.javascript;
            
            patterns.forEach(({ pattern, class: className, replace }) => {
                if (replace) {
                    html = html.replace(pattern, replace);
                } else if (className) {
                    html = html.replace(pattern, `<span class="${className}">$1</span>`);
                }
            });
            
            return html;
        }

        function updateHighlighting() {
            const code = document.getElementById('codeInput').value;
            const activeFile = files.find(f => f.id === activeFileId);
            const language = activeFile ? activeFile.language : 'javascript';
            const highlighted = highlightSyntax(code, language);
            document.getElementById('codeDisplay').innerHTML = highlighted + '\n';
            
            if (activeFile) {
                activeFile.content = code;
            }
        }

        function updateLineNumbers() {
            const code = document.getElementById('codeInput').value;
            const lines = code.split('\n').length;
            const lineNumbers = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
            document.getElementById('lineNumbers').textContent = lineNumbers;
        }

        function syncScroll() {
            const input = document.getElementById('codeInput');
            const display = document.getElementById('codeDisplay');
            const lineNumbers = document.getElementById('lineNumbers');
            
            display.scrollTop = input.scrollTop;
            display.scrollLeft = input.scrollLeft;
            lineNumbers.scrollTop = input.scrollTop;
        }

        function updateStats() {
            const code = document.getElementById('codeInput').value;
            const lines = code.split('\n').length;
            const chars = code.length;
            const words = code.trim() ? code.trim().split(/\s+/).length : 0;
            const size = new Blob([code]).size;
            
            document.getElementById('statLines').textContent = lines;
            document.getElementById('statChars').textContent = chars;
            document.getElementById('statWords').textContent = words;
            document.getElementById('statSize').textContent = formatSize(size);
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }

        function updateMinimap() {
            const code = document.getElementById('codeInput').value;
            document.getElementById('minimapContent').textContent = code;
        }

        function updateCursorPosition() {
            const textarea = document.getElementById('codeInput');
            const text = textarea.value.substring(0, textarea.selectionStart);
            const lines = text.split('\n');
            const line = lines.length;
            const col = lines[lines.length - 1].length + 1;
            document.getElementById('cursorPos').textContent = `–°—Ç—Ä–æ–∫–∞ ${line}, –ö–æ–ª–æ–Ω–∫–∞ ${col}`;
        }

        // File Management
        function newFile() {
            const id = Date.now();
            const language = document.getElementById('languageSelect').value;
            const ext = langExtensions[language];
            const file = {
                id,
                name: `untitled${files.length + 1}.${ext}`,
                content: '',
                language
            };
            files.push(file);
            activeFileId = id;
            updateUI();
            document.getElementById('codeInput').value = '';
            updateHighlighting();
            updateLineNumbers();
            updateStats();
        }

        function openFile(id) {
            activeFileId = id;
            const file = files.find(f => f.id === id);
            if (file) {
                document.getElementById('codeInput').value = file.content;
                document.getElementById('languageSelect').value = file.language;
                updateUI();
                updateHighlighting();
                updateLineNumbers();
                updateStats();
                updateMinimap();
            }
        }

        function closeFile(id, e) {
            e.stopPropagation();
            files = files.filter(f => f.id !== id);
            if (activeFileId === id) {
                if (files.length > 0) {
                    openFile(files[files.length - 1].id);
                } else {
                    newFile();
                }
            }
            updateUI();
        }

        function updateUI() {
            // Update tabs
            const tabsContainer = document.getElementById('tabsContainer');
            const addBtn = tabsContainer.querySelector('.add-tab');
            tabsContainer.innerHTML = '';
            
            files.forEach(file => {
                const tab = document.createElement('div');
                tab.className = `tab ${file.id === activeFileId ? 'active' : ''}`;
                tab.onclick = () => openFile(file.id);
                tab.innerHTML = `
                    <span>${getFileIcon(file.language)} ${file.name}</span>
                    <button class="tab-close" onclick="closeFile(${file.id}, event)">√ó</button>
                `;
                tabsContainer.appendChild(tab);
            });
            
            tabsContainer.appendChild(addBtn);

            // Update file tree
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = files.map(file => `
                <div class="file-item ${file.id === activeFileId ? 'active' : ''}" onclick="openFile(${file.id})">
                    ${getFileIcon(file.language)} ${file.name}
                </div>
            `).join('');

            // Update status bar
            const activeFile = files.find(f => f.id === activeFileId);
            if (activeFile) {
                document.getElementById('currentFile').textContent = activeFile.name;
                document.getElementById('currentLang').textContent = activeFile.language;
            }
        }

        function getFileIcon(language) {
            const icons = {
                javascript: 'üìú', html: 'üåê', css: 'üé®', python: 'üêç',
                json: 'üìã', typescript: 'üí†', java: '‚òï', csharp: 'üî∑',
                cpp: '‚öôÔ∏è', php: 'üêò', ruby: 'üíé', go: 'üêπ', rust: 'ü¶Ä',
                sql: 'üóÉÔ∏è', markdown: 'üìù', xml: 'üìÑ', yaml: '‚ö°',
                swift: 'üçé', kotlin: 'üü£'
            };
            return icons[language] || 'üìÑ';
        }

        function changeLanguage() {
            const language = document.getElementById('languageSelect').value;
            const activeFile = files.find(f => f.id === activeFileId);
            if (activeFile) {
                activeFile.language = language;
                const ext = langExtensions[language];
                const baseName = activeFile.name.split('.')[0];
                activeFile.name = `${baseName}.${ext}`;
                updateUI();
                updateHighlighting();
            }
        }

        function changeFontSize() {
            const size = document.getElementById('fontSizeSelect').value;
            document.getElementById('codeInput').style.fontSize = size + 'px';
            document.getElementById('codeDisplay').style.fontSize = size + 'px';
            document.getElementById('lineNumbers').style.fontSize = size + 'px';
        }

        // File Operations
        function openFileDialog() {
            document.getElementById('fileInput').click();
        }

        function handleFileOpen(event) {
            const fileList = event.target.files;
            Array.from(fileList).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const language = extToLang[ext] || 'javascript';
                    const id = Date.now() + Math.random();
                    files.push({
                        id,
                        name: file.name,
                        content: e.target.result,
                        language
                    });
                    openFile(id);
                    showToast(`‚úÖ –§–∞–π–ª "${file.name}" –æ—Ç–∫—Ä—ã—Ç`);
                };
                reader.readAsText(file);
            });
        }

        function saveFile() {
            const activeFile = files.find(f => f.id === activeFileId);
            if (!activeFile) return;
            
            const blob = new Blob([activeFile.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = activeFile.name;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`üíæ –§–∞–π–ª "${activeFile.name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω`);
        }

        function exportProject() {
            const project = {
                name: 'CodeVision Project',
                timestamp: new Date().toISOString(),
                files: files
            };
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'project.codevision.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('üì¶ –ü—Ä–æ–µ–∫—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
        }

        // Editor Functions
        function copyCode() {
            const code = document.getElementById('codeInput').value;
            const textarea = document.createElement('textarea');
            textarea.value = code;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
        }

        function clearCode() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–æ–¥?')) {
                document.getElementById('codeInput').value = '';
                updateHighlighting();
                updateLineNumbers();
                updateStats();
                updateMinimap();
            }
        }

        function formatCode() {
            const textarea = document.getElementById('codeInput');
            let code = textarea.value;
            const activeFile = files.find(f => f.id === activeFileId);
            const language = activeFile ? activeFile.language : 'javascript';
            
            // Basic formatting
            if (language === 'json') {
                try {
                    code = JSON.stringify(JSON.parse(code), null, 2);
                } catch (e) {
                    showToast('‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è JSON', true);
                    return;
                }
            } else {
                // Basic indentation fix
                let indent = 0;
                code = code.split('\n').map(line => {
                    line = line.trim();
                    if (line.endsWith('}') || line.endsWith(']')) indent = Math.max(0, indent - 1);
                    const result = '  '.repeat(indent) + line;
                    if (line.endsWith('{') || line.endsWith('[') || line.endsWith(':')) indent++;
                    return result;
                }).join('\n');
            }
            
            textarea.value = code;
            updateHighlighting();
            showToast('‚ú® –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω');
        }

        // Search
        function toggleSearch() {
            document.getElementById('searchPanel').classList.toggle('active');
            if (document.getElementById('searchPanel').classList.contains('active')) {
                document.getElementById('searchInput').focus();
            }
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value;
            const code = document.getElementById('codeInput').value;
            
            if (!query) {
                document.getElementById('searchResults').textContent = '0 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π';
                return;
            }
            
            const regex = new RegExp(query, 'gi');
            const matches = code.match(regex);
            const count = matches ? matches.length : 0;
            document.getElementById('searchResults').textContent = `${count} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π`;
        }

        function replaceAll() {
            const search = document.getElementById('searchInput').value;
            const replace = document.getElementById('replaceInput').value;
            
            if (!search) return;
            
            const textarea = document.getElementById('codeInput');
            const regex = new RegExp(search, 'g');
            textarea.value = textarea.value.replace(regex, replace);
            updateHighlighting();
            updateLineNumbers();
            showToast('üîÑ –ó–∞–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
        }

        // Preview
        function togglePreview() {
            const panel = document.getElementById('previewPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                updatePreview();
            }
        }

        function updatePreview() {
            const activeFile = files.find(f => f.id === activeFileId);
            if (!activeFile) return;
            
            const iframe = document.getElementById('previewFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            
            if (activeFile.language === 'html') {
                doc.open();
                doc.write(activeFile.content);
                doc.close();
            } else if (activeFile.language === 'css') {
                doc.open();
                doc.write(`<style>${activeFile.content}</style><p>CSS Preview</p>`);
                doc.close();
            } else if (activeFile.language === 'javascript') {
                doc.open();
                doc.write(`<script>${activeFile.content}<\/script>`);
                doc.close();
            } else if (activeFile.language === 'markdown') {
                const html = activeFile.content
                    .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                    .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                    .replace(/^# (.*)$/gm, '<h1>$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                doc.open();
                doc.write(`<div style="padding:20px;font-family:sans-serif">${html}</div>`);
                doc.close();
            }
        }

        // UI Functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light-theme', !isDarkTheme);
        }

        function showSettings() {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label>–ò–º—è —Ñ–∞–π–ª–∞:</label>
                    <input type="text" id="fileNameInput" value="${files.find(f => f.id === activeFileId)?.name || 'untitled.js'}">
                </div>
                <button class="btn btn-primary" onclick="renameFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
                <hr style="margin: 15px 0; border-color: var(--border)">
                <h4 style="margin-bottom: 10px">üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ</h4>
                <p>–°—Ç—Ä–æ–∫: ${document.getElementById('statLines').textContent}</p>
                <p>–°–∏–º–≤–æ–ª–æ–≤: ${document.getElementById('statChars').textContent}</p>
                <p>–°–ª–æ–≤: ${document.getElementById('statWords').textContent}</p>
                <p>–†–∞–∑–º–µ—Ä: ${document.getElementById('statSize').textContent}</p>
                <hr style="margin: 15px 0; border-color: var(--border)">
                <h4 style="margin-bottom: 10px">‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h4>
                <p>Ctrl+S - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª</p>
                <p>Ctrl+F - –ü–æ–∏—Å–∫</p>
                <p>Ctrl+N - –ù–æ–≤—ã–π —Ñ–∞–π–ª</p>
                <p>Tab - –û—Ç—Å—Ç—É–ø</p>
                <p>Shift+Tab - –£–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø</p>
            `;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function renameFile() {
            const newName = document.getElementById('fileNameInput').value;
            const activeFile = files.find(f => f.id === activeFileId);
            if (activeFile && newName) {
                activeFile.name = newName;
                const ext = newName.split('.').pop();
                if (extToLang[ext]) {
                    activeFile.language = extToLang[ext];
                    document.getElementById('languageSelect').value = activeFile.language;
                }
                updateUI();
                closeModal();
                showToast('‚úÖ –§–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω');
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                closeModal();
            }
        });
    </script>
</body>
</html>

